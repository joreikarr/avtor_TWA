<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дисертація</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4" id="work_type_text">Дисертація</h1>

        <!-- Таблица для Гуманітарних дисциплін -->
        <div class="table-responsive mb-4">
            <h3 class="text-center">Гуманітарні дисципліни</h3>
            <table class="table table-bordered" id="humanitarianTable">
                <thead>
                    <tr>
                        <th rowspan="2">Строк</th>
                        <th colspan="5" class="text-center">Унікальність</th>
                    </tr>
                    <tr>
                        <th>50-59%</th>
                        <th>60-69%</th>
                        <th>70-79%</th>
                        <th>80-89%</th>
                        <th>90-100%</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Таблица для Технічних дисциплін -->
        <div class="table-responsive mb-4">
            <h3 class="text-center">Технічні дисципліни</h3>
            <table class="table table-bordered" id="technicalTable">
                <thead>
                    <tr>
                        <th rowspan="2">Строк</th>
                        <th colspan="5" class="text-center">Унікальність</th>
                    </tr>
                    <tr>
                        <th>50-59%</th>
                        <th>60-69%</th>
                        <th>70-79%</th>
                        <th>80-89%</th>
                        <th>90-100%</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        function decodeData(encodedData) {
            let decodedData = atob(encodedData);
            return decodedData.replace(/\s/g, '');
        }

        const urlParams = new URLSearchParams(window.location.search);
        let work_type = urlParams.get('work_type')?.replaceAll('_', ' ') || 'Дисертація';
        document.getElementById('work_type_text').innerHTML = work_type;

        let tg = window.Telegram.WebApp; 
        tg.MainButton.text = "Відправити";

        let incomingData = decodeData(urlParams.get('incomingData'));

        const rowTitles = [
            "1 день", "2-3 дні", "4-6 днів", "7-10 днів",
            "11-14 днів", "15-20 днів", "20 і більше днів"
        ];

        function populateTable(raw_data) {
            let tablesData = raw_data.split('_');
            
            tablesData.forEach((tableData, tableIndex) => {
                let rows = tableData.split('/'); 
                let table = tableIndex === 0 ? document.getElementById('humanitarianTable') : document.getElementById('technicalTable');
                let tbody = table.querySelector('tbody');
                
                rows.forEach((rowData, rowIndex) => {
                    let cells = rowData.split('*'); 
                    let row = document.createElement('tr');

                    let td = document.createElement('td');
                    td.textContent = rowTitles[rowIndex] || `Строка ${rowIndex + 1}`;
                    row.appendChild(td);
                    
                    cells.forEach(cellData => {
                        let tdCell = document.createElement('td'); 
                        let input = document.createElement('input');
                        input.type = 'text'; 
                        input.classList.add('form-control');
                        // при инициализации тоже заменяем точки на запятые
                        input.value = cellData.replace(/\./g, ','); 
                        tdCell.appendChild(input); 
                        row.appendChild(tdCell); 
                    });

                    tbody.appendChild(row);
                });
            });
        }

        // заполнение таблицы
        populateTable(incomingData);

        // Автозамена точки на запятую при вводе
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT') {
                if (e.target.value.includes('.')) {
                    e.target.value = e.target.value.replace(/\./g, ',');
                }
            }
        });

        // Кнопка отправки
        tg.MainButton.show().onClick(function() {
            let tables = [document.getElementById('humanitarianTable'), document.getElementById('technicalTable')];
            let dataToSend = [];

            tables.forEach(table => {
                let rows = table.querySelectorAll('tbody tr');
                let tableData = [];
                rows.forEach(row => {
                    let rowData = [];
                    row.querySelectorAll('input').forEach(input => {
                        // при сборе данных заменяем запятую обратно на точку
                        rowData.push(input.value.replace(/,/g, '.'));
                    });
                    tableData.push(rowData.join('*'));
                });
                dataToSend.push(tableData.join('/'));
            });

            let dataString = dataToSend.join('_') + "-" + work_type;
            console.log('Отправляемые данные:', dataString);
            try {
                tg.sendData(dataString);
            } catch (e) {
                console.error('Ошибка отправки данных:', e);
            }
        });
    </script>
</body>
</html>
